---
// Remove Image import - we don't need it anymore
// import { Image } from 'astro:assets';

const services = [
  {
    title: "High-Converting Websites",
    description: "Custom designed sites built to turn visitors into paying customers. Mobile-friendly and lightning fast.",
    color: "bg-blue-50",
    image: "/images/services/high-converting-websites.webp",
    svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>`
  },
  {
    title: "Local SEO Domination",
    description: "Get found when people search for \"plumber near me\" or \"best builder in town\". We optimise your entire footprint.",
    color: "bg-green-50",
    image: "/images/services/local-seo.webp",
    svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`
  },
  {
    title: "Lead Generation",
    description: "Systems setup to capture leads automatically, so you never miss a quote request while on the job.",
    color: "bg-orange-50",
    image: "/images/services/lead-generation.webp",
    svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="20" x="5" y="2" rx="2"/><path d="M12 18h.01"/></svg>`
  },
  {
    title: "Trust & Credibility",
    description: "Showcase your reviews, certifications, and past work to prove you are the best choice in your area.",
    color: "bg-purple-50",
    image: "/images/services/trust-credibility.webp",
    svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="m9 12 2 2 4-4"/></svg>`
  },
  {
    title: "Google Ads Management",
    description: "Instant leads while your SEO builds up. We manage your ad spend to maximize ROI and lower cost-per-lead.",
    color: "bg-yellow-50",
    image: "/images/services/google-ads.webp",
    svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"/></svg>`
  },
  {
    title: "Trade Specific Content",
    description: "We know your industry. We write copy that speaks directly to homeowners and contractors.",
    color: "bg-indigo-50",
    image: "/images/services/trade-content.webp",
    svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 12-8.373 8.373a1 1 0 1 1-3-3L12 9"/><path d="m18 15 4-4"/><path d="m21.5 11.5-1.914-1.914A2 2 0 0 1 19 8.172V7l-2.26-2.26a6 6 0 0 0-4.202-1.756L9 2.96l.92.82A6.18 6.18 0 0 1 12 8.4V10l2 2h1.172a2 2 0 0 1 1.414.586L18.5 14.5"/></svg>`
  }
];
---

<section id="services" class="services-wrapper">
  <div class="services-container">
    <div class="services-header">
      <h2 class="services-label" style="color:black">Our Services</h2>
      <h3 class="services-title">Everything You Need To Grow</h3>
      <p class="services-main-desc">We don't just build pretty websites. We build digital assets that work as hard as you do.</p>
    </div>

    <!-- The Horizontal Deck -->
    <div class="deck-viewport">
      <div class="deck-track">
        {services.map((service, index) => (
          <div class={`deck-card card-${index}`}>
            <div class="card-image-wrapper">
              <img 
                src={service.image} 
                alt={service.title} 
                class="card-image" 
                loading="lazy"
              />
              <div class="card-overlay"></div>
              <div class="card-icon-badge">
                 <div class="icon-inner" set:html={service.svg} />
              </div>
            </div>
            <div class="card-content">
              <h4 class="card-title">{service.title}</h4>
              <p class="card-desc">{service.description}</p>
              <div class="card-footer">
                <span class="learn-more">Learn more <span class="arrow">â†’</span></span>
              </div>
            </div>
          </div>
        ))}
      </div>
      
      <!-- Mobile Progress Indicator -->
      <div class="mobile-progress">
        <div class="progress-bar">
          <div class="progress-fill"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .services-wrapper {
    background: #fff;
    padding: 4rem 0;
    position: relative;
    overflow: hidden;
  }

  .services-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 1rem;
    height: 100%;
  }

  .services-header {
    text-align: center;
    max-width: 48rem;
    margin: 0 auto 3rem;
    padding: 0 1rem;
  }

  .services-label {
    color: var(--color-gold-500);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.875rem;
    margin-bottom: 0.75rem;
  }

  .services-title {
    font-family: var(--font-heading);
    font-size: 2.25rem;
    color: var(--color-navy-900);
    line-height: 1.1;
    margin-bottom: 1rem;
  }

  .services-main-desc {
    font-size: 1.125rem;
    color: #64748b;
    line-height: 1.6;
  }

  /* DECK STYLES (Mobile First) */
  .deck-viewport {
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 2rem;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  
  .deck-viewport::-webkit-scrollbar { 
    display: none; 
  }

  .deck-track {
    display: flex;
    gap: 1rem;
    padding: 0 1rem;
    width: max-content;
  }

  .deck-card {
    flex: 0 0 85vw;
    scroll-snap-align: center;
    background: #fff;
    border-radius: 1.5rem;
    overflow: hidden;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    display: flex;
    flex-direction: column;
    height: 500px;
    position: relative;
    transition: all 0.3s ease;
    will-change: transform;
  }

  .card-image-wrapper {
    height: 45%;
    width: 100%;
    position: relative;
    overflow: hidden;
    background: #f8fafc;
  }

  .card-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    display: block;
    will-change: transform;
    transform: scale(1);
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .card-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0.1) 100%);
    pointer-events: none;
  }

  .card-icon-badge {
    position: absolute;
    top: 1.5rem;
    left: 1.5rem;
    width: 3.5rem;
    height: 3.5rem;
    background: var(--color-navy-900);
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    z-index: 10;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
  }

  .icon-inner {
    width: 1.75rem;
    height: 1.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .icon-inner svg {
    width: 100%;
    height: 100%;
    stroke-width: 2.5;
    display: block;
  }

  .card-content {
    padding: 2rem 1.75rem;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    background: #fff;
  }

  .card-title {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-navy-900);
    margin-bottom: 0.75rem;
    line-height: 1.3;
  }

  .card-desc {
    color: #64748b;
    font-size: 0.9375rem;
    line-height: 1.65;
    margin-bottom: 1.5rem;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 1.25rem;
    border-top: 1px solid #f1f5f9;
    margin-top: auto;
  }

  .learn-more {
    color: var(--color-gold-500);
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: color 0.3s ease;
  }

  .arrow {
    transition: transform 0.3s ease;
    display: inline-block;
  }

  .deck-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  .deck-card:hover .arrow {
    transform: translateX(4px);
  }

  .deck-card:hover .card-image {
    transform: scale(1.08);
  }

  .deck-card:hover .learn-more {
    color: var(--color-gold-600);
  }


  /* Mobile Progress Bar */
  .mobile-progress {
    width: 200px;
    height: 4px;
    background: #e2e8f0;
    border-radius: 2px;
    margin: 2rem auto 0;
    overflow: hidden;
  }
  
  .progress-fill {
    width: 16.66%;
    height: 100%;
    background: var(--color-navy-900);
    border-radius: 2px;
    transition: transform 0.1s linear;
  }

  /* DESKTOP ENHANCEMENTS */
  @media (min-width: 1024px) {
    .services-wrapper {
      padding: 8rem 0;
    }

    .services-title {
      font-size: 3.5rem;
    }

    .deck-viewport {
      overflow: visible;
      height: auto;
      padding-bottom: 0;
    }

    .deck-track {
      flex-wrap: nowrap;
      width: fit-content;
      padding: 0;
      gap: 2.5rem;
    }

    .deck-card {
      flex: 0 0 420px;
      height: 580px;
      scroll-snap-align: none;
    }

    .card-image-wrapper {
      height: 48%;
    }

    .card-content {
      padding: 2.25rem 2rem;
    }

    .card-title {
      font-size: 1.625rem;
    }

    .card-desc {
      font-size: 1rem;
      -webkit-line-clamp: 4;
    }

    .mobile-progress {
      display: none;
    }
  }
</style>

<script>
  function waitForGSAP(callback) {
    if (typeof window !== 'undefined' && window.gsap && window.ScrollTrigger) {
      callback();
    } else {
      setTimeout(() => waitForGSAP(callback), 50);
    }
  }

  function initDeckAnimations() {
    gsap.registerPlugin(ScrollTrigger);
    
    // Use requestAnimationFrame to batch layout reads
    requestAnimationFrame(() => {
      // --- MOBILE SCROLL PROGRESS ---
      const viewport = document.querySelector('.deck-viewport');
      const progressFill = document.querySelector('.progress-fill');
      
      if (viewport && progressFill) {
        // Use passive event listener for better performance
        viewport.addEventListener('scroll', () => {
          requestAnimationFrame(() => {
            const maxScroll = viewport.scrollWidth - viewport.clientWidth;
            const scroll = viewport.scrollLeft;
            const progress = scroll / maxScroll;
            const percent = Math.min(Math.max(progress, 0), 1);
            progressFill.style.transform = `translateX(${percent * 500}%)`;
          });
        }, { passive: true });
      }

      // --- DESKTOP SCROLLTRIGGER ---
      const mm = gsap.matchMedia();
      
      mm.add("(min-width: 1024px)", () => {
        // Batch all layout reads first
        const track = document.querySelector('.deck-track');
        if (!track) return;
        
        // Read all layout properties in one batch
        const trackRect = track.getBoundingClientRect();
        const totalWidth = track.scrollWidth;
        const windowWidth = window.innerWidth;
        const amountToScroll = totalWidth - windowWidth + 400;

        // Then perform writes
        const scrollTween = gsap.to(track, {
          x: -amountToScroll,
          ease: "none",
          scrollTrigger: {
            trigger: ".services-wrapper",
            pin: true,
            scrub: 1,
            start: "center center-=100",
            end: "+=2000",
            anticipatePin: 1,
            refreshPriority: -1 // Lower priority to reduce reflows
          }
        });
      });
    });
  }

  // Delay initialization slightly to let browser finish initial layout
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        waitForGSAP(initDeckAnimations);
      }, 100);
    });
  } else {
    setTimeout(() => {
      waitForGSAP(initDeckAnimations);
    }, 100);
  }
</script>
