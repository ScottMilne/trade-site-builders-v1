---
const services = [
  {
    title: "High-Converting Websites",
    description: "Custom designed sites built to turn visitors into paying customers. Mobile-friendly and lightning fast.",
    color: "bg-blue-50",
    svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>`
  },
  {
    title: "Local SEO Domination",
    description: "Get found when people search for \"plumber near me\" or \"best builder in town\". We optimise your entire footprint.",
    color: "bg-green-50",
    svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>`
  },
  {
    title: "Lead Generation",
    description: "Systems setup to capture leads automatically, so you never miss a quote request while on the job.",
    color: "bg-orange-50",
    svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="14" height="20" x="5" y="2" rx="2"/><path d="M12 18h.01"/></svg>`
  },
  {
    title: "Trust & Credibility",
    description: "Showcase your reviews, certifications, and past work to prove you are the best choice in your area.",
    color: "bg-purple-50",
    svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="m9 12 2 2 4-4"/></svg>`
  },
  {
    title: "Google Ads Management",
    description: "Instant leads while your SEO builds up. We manage your ad spend to maximize ROI and lower cost-per-lead.",
    color: "bg-yellow-50",
    svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"/></svg>`
  },
  {
    title: "Trade Specific Content",
    description: "We know your industry. We write copy that speaks directly to homeowners and contractors.",
    color: "bg-indigo-50",
    svg: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 12-8.373 8.373a1 1 0 1 1-3-3L12 9"/><path d="m18 15 4-4"/><path d="m21.5 11.5-1.914-1.914A2 2 0 0 1 19 8.172V7l-2.26-2.26a6 6 0 0 0-4.202-1.756L9 2.96l.92.82A6.18 6.18 0 0 1 12 8.4V10l2 2h1.172a2 2 0 0 1 1.414.586L18.5 14.5"/></svg>`
  }
];

const projects = [
  {
    title: "Highland Hearth",
    category: "Bricklaying & Stoves",
    image: "/images/projects/highlandhearth.png",
    description: "Premium brickwork and stove installations across the Highlands.",
    link: "https://highlandhearth.co.uk"
  },
  {
    title: "Tayside Tiling",
    category: "Tiling",
    image: "/images/projects/taysidetiling.png",
    description: "Expert wall and floor tiling services for bathrooms and kitchens.",
    link: "https://taysidetiling.co.uk"
  },
  {
    title: "Highland Leaf",
    category: "Landscaping",
    image: "/images/projects/highlandleaf.png",
    description: "Complete landscape gardening and outdoor transformations.",
    link: "https://highlandleaf.co.uk"
  },
  {
    title: "Dundee Design",
    category: "Painting & Decorating",
    image: "/images/projects/dundeedesign.png",
    description: "High-end interior and exterior decorating services.",
    link: "https://dundeedesign.co.uk"
  }
];
---

<section id="services" class="services-wrapper">
  <div class="services-container">
    <div class="services-header">
      <h2 class="services-label" style="color:var(--color-navy-900)">Our Services</h2>
      <h3 class="services-title">Everything You Need To Grow</h3>
      <p class="services-main-desc">We don't just build pretty websites. We build digital assets that work as hard as you do.</p>
    </div>

    <!-- Services Grid -->
    <div class="services-grid">
      {services.map((service) => (
        <div class="service-card">
          <div class={`service-icon-box ${service.color}`}>
             <div class="service-icon" set:html={service.svg} />
          </div>
          <h4 class="service-card-title">{service.title}</h4>
          <p class="service-card-desc">{service.description}</p>
        </div>
      ))}
    </div>
  </div>
</section>

<!-- Recent Work Horizontal Deck -->
<section id="recent-work" class="recent-work-wrapper">
  <div class="services-container"> <!-- reusing container for width -->
    <div class="services-header">
      <h2 class="services-label" style="color:var(--color-gold-500)">Recent Work</h2>
      <h3 class="services-title" style="color:white">Built For Results</h3>
      <p class="services-main-desc" style="color: #94a3b8">Check out some of our latest projects helping tradespeople dominate their local areas.</p>
    </div>

    <div class="deck-viewport">
       <div class="deck-track">
         {projects.map((project, index) => (
           <div class={`deck-card card-${index}`}>
             <div class="card-image-wrapper">
               <img 
                 src={project.image} 
                 alt={project.title} 
                 class="card-image" 
                 loading="lazy"
               />
               <div class="card-overlay"></div>
             </div>
             <div class="card-content">
               <span class="project-tag">{project.category}</span>
               <h4 class="card-title">{project.title}</h4>
               <p class="card-desc">{project.description}</p>
               <div class="card-footer">
                  <a href={project.link} target="_blank" rel="noopener noreferrer" class="learn-more">Visit Website <span class="arrow">â†’</span></a>
               </div>
             </div>
           </div>
         ))}
         
         <!-- View More Card -->
         <a href="/our-work" class="deck-card view-more-card">
             <div class="view-more-content">
                 <span class="view-more-circle">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                 </span>
                 <h4 class="view-more-title">View All Projects</h4>
                 <p class="view-more-desc">See our full portfolio of trade websites.</p>
             </div>
         </a>
       </div>
       
       <!-- Mobile Progress -->
       <div class="mobile-progress">
         <div class="progress-bar">
           <div class="progress-fill"></div>
         </div>
       </div>
    </div>
  </div>
</section>

<style>
  /* --- SERVICES GRID SECTION --- */
  .services-wrapper {
    background: #fff;
    padding: 6rem 0;
    position: relative;
  }

  .services-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 1rem;
  }

  .services-header {
    text-align: center;
    max-width: 48rem;
    margin: 0 auto 4rem;
    padding: 0 1rem;
  }

  .services-label {
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.875rem;
    margin-bottom: 0.75rem;
  }

  .services-title {
    font-family: var(--font-heading);
    font-size: 2.5rem;
    color: var(--color-navy-900);
    line-height: 1.1;
    margin-bottom: 1rem;
  }

  .services-main-desc {
    font-size: 1.125rem;
    color: #64748b;
    line-height: 1.6;
  }

  .services-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
  }

  @media (min-width: 768px) {
    .services-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .services-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .service-card {
    background: #f8fafc;
    border-radius: 1rem;
    padding: 2.5rem 2rem;
    transition: all 0.3s ease;
    border: 1px solid #f1f5f9;
  }

  .service-card:hover {
    transform: translateY(-5px);
    background: #fff;
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
    border-color: #e2e8f0;
  }

  .service-icon-box {
    width: 3.5rem;
    height: 3.5rem;
    border-radius: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.5rem;
    color: var(--color-navy-900);
  }
  
  .service-icon {
    width: 1.75rem;
    height: 1.75rem;
  }

  .service-card-title {
    font-family: var(--font-heading);
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--color-navy-900);
    margin-bottom: 0.75rem;
  }

  .service-card-desc {
    color: #64748b;
    line-height: 1.6;
    font-size: 1rem;
  }

  /* --- RECENT WORK SECTION (Dark Theme) --- */
  .recent-work-wrapper {
    background: var(--color-navy-900);
    padding: 6rem 0;
    position: relative;
    overflow: hidden;
    color: white;
  }

  /* DECK STYLES Reused/Adapted */
  .deck-viewport {
    width: 100%;
    overflow-x: auto;
    overflow-y: hidden;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 2rem;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  
  .deck-viewport::-webkit-scrollbar { display: none; }

  .deck-track {
    display: flex;
    gap: 1.5rem;
    padding: 0 1rem;
    width: max-content;
  }

  .deck-card {
    flex: 0 0 85vw;
    scroll-snap-align: center;
    background: #fff;
    border-radius: 1.5rem;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 500px;
    position: relative;
    transition: all 0.3s ease;
    text-decoration: none; /* for link card */
    color: inherit;
  }

  .card-image-wrapper {
    height: 55%; /* More image focus for projects */
    width: 100%;
    position: relative;
    overflow: hidden;
    background: #f1f5f9;
  }

  .card-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: top center;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .deck-card:hover .card-image {
    transform: scale(1.05);
  }

  .card-content {
    padding: 2rem;
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #fff;
  }
  
  .project-tag {
    color: var(--color-gold-500);
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
  }

  .card-title {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--color-navy-900);
    margin-bottom: 0.5rem;
  }

  .card-desc {
    color: #64748b;
    font-size: 0.9375rem;
    line-height: 1.6;
    margin-bottom: auto;
  }

  .card-footer {
    padding-top: 1.5rem;
    border-top: 1px solid #f1f5f9;
    margin-top: 1.5rem;
  }

  .learn-more {
    color: var(--color-navy-900);
    font-weight: 600;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
  }
  
  .arrow { transition: transform 0.2s; }
  .deck-card:hover .arrow { transform: translateX(4px); }

  /* View More Card Styles */
  .view-more-card {
    background: var(--color-gold-500);
    border: none;
    align-items: center;
    justify-content: center;
    text-align: center;
  }
  
  .view-more-content {
    padding: 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--color-navy-900);
  }
  
  .view-more-circle {
    width: 4rem;
    height: 4rem;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.5rem;
    transition: transform 0.3s ease;
  }
  
  .view-more-card:hover .view-more-circle {
    transform: scale(1.1);
    background: rgba(255,255,255,0.3);
  }
  
  .view-more-title {
    font-family: var(--font-heading);
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  /* Mobile Progress Bar */
  .mobile-progress {
    width: 200px;
    height: 4px;
    background: rgba(255,255,255,0.1);
    border-radius: 2px;
    margin: 2rem auto 0;
    overflow: hidden;
  }
  
  .progress-fill {
    width: 20%; /* 1 of 5 items */
    height: 100%;
    background: var(--color-gold-500);
    border-radius: 2px;
  }

  /* DESKTOP ENHANCEMENTS */
  @media (min-width: 1024px) {
    .deck-viewport {
      overflow: visible;
      height: auto;
      padding-bottom: 0;
    }

    .deck-track {
      flex-wrap: nowrap;
      width: fit-content;
      padding: 0;
      gap: 2.5rem;
    }

    .deck-card {
      flex: 0 0 400px;
      height: 550px;
      scroll-snap-align: none;
    }

    .mobile-progress {
      display: none;
    }
  }
</style>

<script>
  function waitForGSAP(callback) {
    if (typeof window !== 'undefined' && window.gsap && window.ScrollTrigger) {
      callback();
    } else {
      setTimeout(() => waitForGSAP(callback), 50);
    }
  }

  function initDeckAnimations() {
    gsap.registerPlugin(ScrollTrigger);
    
    requestAnimationFrame(() => {
      // --- MOBILE SCROLL PROGRESS for Recent Work ---
      const viewport = document.querySelector('.deck-viewport');
      const progressFill = document.querySelector('.progress-fill');
      
      if (viewport && progressFill) {
        viewport.addEventListener('scroll', () => {
          requestAnimationFrame(() => {
            const maxScroll = viewport.scrollWidth - viewport.clientWidth;
            const scroll = viewport.scrollLeft;
            const progress = scroll / maxScroll;
            const percent = Math.min(Math.max(progress, 0), 1);
            progressFill.style.transform = `translateX(${percent * 400}%)`; // approximate
          });
        }, { passive: true });
      }

      // --- DESKTOP SCROLLTRIGGER for Recent Work ---
      const mm = gsap.matchMedia();
      
      mm.add("(min-width: 1024px)", () => {
        const track = document.querySelector('.deck-track');
        if (!track) return;
        
        const trackRect = track.getBoundingClientRect();
        const totalWidth = track.scrollWidth;
        const windowWidth = window.innerWidth;
        const amountToScroll = totalWidth - windowWidth + 400; // Extra padding

        gsap.to(track, {
          x: -amountToScroll,
          ease: "none",
          scrollTrigger: {
            trigger: ".recent-work-wrapper", // CHANGED from services-wrapper
            pin: true,
            scrub: 1,
            start: "center center", // Pin when center of section hits center of viewport
            end: "+=1000", // Even shorter scroll
            anticipatePin: 1,
            refreshPriority: -1
          }
        });
      });
      
      // Animate Services Grid
      // Use batch to avoid layout thrashing and handle visibility better
      const cards = gsap.utils.toArray('.service-card');
      if (cards.length > 0) {
        gsap.set(cards, { opacity: 0, y: 30 }); // Set initial hidden state in JS
        
        ScrollTrigger.batch(cards, {
          onEnter: batch => gsap.to(batch, {opacity: 1, y: 0, stagger: 0.15, overwrite: true}),
          start: "top 85%",
          once: true // Keep them visible once shown
        });
      }
    });
  }

  // Init
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        waitForGSAP(initDeckAnimations);
      }, 100);
    });
  } else {
    setTimeout(() => {
      waitForGSAP(initDeckAnimations);
    }, 100);
  }
</script>
